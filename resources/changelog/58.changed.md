Refactor code to avoid memory leaks